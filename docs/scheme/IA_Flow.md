

# ✅ 1. 产品框架图（Information Architecture）

```
PaperHealth App
│
├── 首页（Timeline）
│     ├── 人员切换栏（Tab: 本人 / 家人 / +新增）
│     ├── 搜索栏
│     ├── 筛选功能（日期 / 标签）
│     ├── 待确认区（is_pending = true）
│     │      └── 待确认列表页
│     └── 时间轴列表（按 visit_date）
│             └── 事件卡片（Event）
│                   └── 缩略图（Image[]）
│
├── 拍照 / 导入（Capture）
│     ├── 相机页面
│     ├── 多图预览页（裁剪、旋转、删除）
│     └── 开始处理 → 返回首页 → Toast
│
├── 详情页（Event Detail）
│     ├── 顶部图片浏览（1/N）
│     ├── 字段编辑区
│     │      ├── 归档对象
│     │      ├── 医院
│     │      ├── 日期
│     │      ├── 标签（自动 + 自定义）
│     │      └── OCR 全文
│     └── 操作功能
│            ├── 保存
│            ├── 删除
│            ├── 重新识别
│            └── 对比模式
│
├── 设置（Settings）
│     ├── 标签管理
│     ├── 人员管理
│     ├── 备份/恢复
│     ├── 安全锁（FaceID / PIN）
│     └── 问题反馈（Email / GitHub）
│
└── 异步 OCR 流程（后台）
       ├── 本地 OCR
       ├── 置信度评估
       ├── 自动归档 or 待确认
       └── 通知系统（任务完成）
```

---

# ✅ 2. 核心用户流程图（User Flow）
按照下面这个流程，请开始写拍照/上传，以及OCR的代码。
## **Flow 1：添加医疗档案（核心）**

```
用户 → 首页
      → 点击“拍照”
          → 调起相机
              → 拍摄/选择多张图片
                  → 预览与编辑（裁剪 / 删除）
                      → 点击「开始处理并归档」
                          → App 返回首页
                              → Toast “处理中…”
                                  → 后台 OCR 处理
                                      → 判断置信度
                                          ├── 高 → 自动归档 → Timeline 追加事件
                                          └── 低 → 标记为待确认 → 待确认区
```

---

## **Flow 2：处理待确认档案（is_pending = true）**

```
用户 → 首页
      → 看到“待确认[N]”
          → 点击进入待确认列表
              → 选择卡片
                  → 进入详情页
                      → 编辑医院/日期/标签
                          → 保存
                              → is_pending = false
                              → 事件插入 Timeline
                              → 返回待确认列表（已减少一条）
```

---

## **Flow 3：查看与编辑某个事件（Event Detail）**

```
用户 → 首页 → Timeline 卡片 → 点击进入详情页
       → 滑动浏览多张图片
       → 编辑字段（医院 / 日期 / 标签）
       → 展开查看 OCR 全文
       → 如需：重新识别 / 分屏对比
       → 保存 → Timeline 更新
```

---

## **Flow 4：标签管理流程（Tag Management）**

```
用户 → 设置 → 标签管理
         → 选择人员
             → 查看标签列表（该人员的自定义标签）
                 → 新增标签
                 → 编辑标签
                 → 删除标签（影响所有图片）
```

---

## **Flow 5：备份 / 恢复流程**

```
用户 → 设置 → 备份
       → 生成 .phbak 加密文件 → 保存到本地

用户 → 设置 → 恢复
       → 选择 .phbak 文件 → 输入密钥
       → 覆盖当前数据库 → App 重载数据
```

---

# ✅ 3. 交互逻辑（Interaction Rules）

## **3.1 事件生成逻辑（Event Creation）**

```
一次拍照/导入 → 永远对应一个事件（Event）
Event 下可能包含 N 张图片（Image[]）

所有图片 → 共用同一组顶层字段：
- visit_date
- hospital_name
- personnel_id
```

---

## **3.2 置信度分流逻辑（非常关键）**

```
OCR → confidence > 0.9 → 自动归档
OCR → confidence ≤ 0.9 → 进入待确认
```

字段：

* 日期（日期识别最容易出问题）
* 医院名称
* 标签推断

进入详情页时，低置信度字段用黄色警告展示。

---

## **3.3 标签逻辑（Tag System）**

```
每张图片必须至少一个标签（自动 or 自定义）

标签分类型：
- 自动标签（系统生成）
- 自定义标签（用户创建）
- 通用标签（personnel_id = null）

筛选行为：
- 多选标签 → Timeline 立即过滤
```

---

## **3.4 Timeline 排序逻辑**

```
主排序字段：visit_date（倒序）
如果 visit_date 为空 → 使用 created_at 排序（倒序）
```

---

## **3.5 页面生命周期刷新**

```
App 从后台回到前台时：
- 自动拉取 OCR 状态
- 自动刷新待确认数量
- 自动更新 Timeline
```

---

## **3.6 安全锁逻辑**

```
触发时机：
- 冷启动
- 从后台恢复

解锁方式：
- FaceID / TouchID
- PIN 码（Fallback）
```

---


